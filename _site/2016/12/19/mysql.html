<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Sql</title>
  <meta name="description" content="数据库">
  <link rel="shortcut icon" type="image/x-icon" href="/blog/favicon.ico" />
  <link rel="stylesheet" href="/blog/css/main.css">
  <link rel="canonical" href="http://localhost:4000/blog/2016/12/19/mysql.html">
  <link rel="alternate" type="application/rss+xml" title="newlifebegins" href="http://localhost:4000/blog/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/blog/">newlifebegins</a>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Sql</h1>
    <p class="post-meta"><time datetime="2016-12-19T00:00:00+08:00" itemprop="datePublished">Dec 19, 2016</time></p>
  </header>

  <div class="markdown-body" itemprop="articleBody">
    <h2 id="数据库">数据库</h2>

<p>数据库是一个以某种有组织的方式存储的数据集合(通常是一个文件或一组文件)</p>

<h2 id="表">表</h2>

<p>表是一种结构化的文件，可以用来存储某种特定类型的数据，表在数据库中是唯一的</p>

<h2 id="模式">模式</h2>

<p>表具有一些特性，这些特性定义了表在数据库中如何存储，包含存储什么样的数据，数据如何分解，各部分信息如何命名等，描述表的这组信息就是模式(scheme).</p>

<h2 id="列">列</h2>

<p>表中的一个字段，所有表都是由一个或多个列组成的</p>

<h2 id="数据类型">数据类型</h2>

<p>每个表列都有相应的数据类型，它限制该列中存储的数据</p>

<h2 id="行">行</h2>

<p>表中的一个记录 有时候也被称为一条记录</p>

<h2 id="主键">主键</h2>

<p>表中的每一行都应该有一列（或几列）可以唯一标识自己，每个表都应该有主键，方便更新和删除表中特定行</p>

<p>需要满足以下要求中的表中任何列都可以作为主键:</p>

<ul>
  <li>任意两行不具有相同的主键值</li>
  <li>每一行必须具有一个主键值</li>
  <li>主键列中的值不允许修改和更新</li>
  <li>主键值不能重用(如果某行从表中删除，它的主键不能赋值给新增的行)</li>
</ul>

<h2 id="sql">sql</h2>

<p><code class="highlighter-rouge">Strctured Query Language</code> 结构化查询语言，是一门和数据库沟通的语言。不同于一般的程序语言，sql中只有很少的关键字</p>

<p>sql 优点:</p>

<ul>
  <li>sql不是某个特定数据库供应商专有的语言</li>
  <li>sql简单易学</li>
  <li>灵活使用sql可以进行非常复杂和高级的数据操作</li>
</ul>

<h2 id="玩具经销商使用的订单录入系统">玩具经销商使用的订单录入系统</h2>

<p><code class="highlighter-rouge">vendors</code>表</p>

<p><code class="highlighter-rouge">vendors</code>表存储销售产品的供应商</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">Vendors</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Vendors</span>
<span class="p">(</span>
  <span class="n">vend_id</span> <span class="n">INT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="n">vend_name</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="n">vend_country</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
  <span class="n">vend_provice</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
  <span class="n">vend_city</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
  <span class="n">vend_address</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
  <span class="n">vend_zip</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">)</span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">Products</code>表</p>

<p><code class="highlighter-rouge">Products</code>表中包含所有产品，每行代表一个</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">Products</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Products</span>
<span class="p">(</span>
<span class="n">prod_id</span> <span class="n">INT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
<span class="n">vend_id</span> <span class="n">INT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
<span class="n">prod_name</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
<span class="n">prod_price</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
<span class="n">prod_desc</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">vend_id</span><span class="p">)</span>
      <span class="k">REFERENCES</span> <span class="n">Vendors</span><span class="p">(</span><span class="n">vend_id</span><span class="p">)</span>
<span class="p">)</span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">Customers</code>表</p>

<p><code class="highlighter-rouge">Customers</code>表中存储所有顾客信息</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">Customers</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Customers</span>
<span class="p">(</span>
<span class="n">cust_id</span> <span class="n">INT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span>  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
<span class="n">cust_name</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
<span class="n">cust_address</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
<span class="n">cust_city</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
<span class="n">cust_provice</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
<span class="n">cust_zip</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
<span class="n">cust_county</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
<span class="n">cust_contact</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
<span class="n">cust_email</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">)</span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">Orders</code>表</p>

<p><code class="highlighter-rouge">Orders</code> 表存储顾客订单</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">Orders</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Orders</span>
<span class="p">(</span>
<span class="n">order_num</span> <span class="n">INT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
<span class="n">order_date</span> <span class="k">TIMESTAMP</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span> <span class="p">,</span>
<span class="n">cust_id</span> <span class="n">INT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">cust_id</span><span class="p">)</span>
      <span class="k">REFERENCES</span> <span class="n">Customers</span><span class="p">(</span><span class="n">cust_id</span><span class="p">)</span>
<span class="p">)</span><span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">OrderItems</code>表</p>

<p><code class="highlighter-rouge">OrderItems</code>表中存储每个订单的实际物品</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="n">OrderItems</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">OrderItems</span>
<span class="p">(</span>
<span class="n">order_item</span> <span class="n">INT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span>  <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
<span class="n">order_num</span> <span class="n">INT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">REFERENCES</span> <span class="n">Orders</span><span class="p">(</span><span class="n">order_num</span><span class="p">),</span>
<span class="n">prod_id</span> <span class="n">INT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">REFERENCES</span> <span class="n">Products</span><span class="p">(</span><span class="n">prod_id</span><span class="p">),</span>
<span class="n">quantity</span> <span class="n">INT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
<span class="n">item_price</span> <span class="n">FLOAT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
<span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">order_num</span><span class="p">)</span>
  <span class="k">REFERENCES</span> <span class="n">Orders</span><span class="p">(</span><span class="n">order_num</span><span class="p">),</span>
<span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">prod_id</span><span class="p">)</span>
  <span class="k">REFERENCES</span> <span class="n">Products</span><span class="p">(</span><span class="n">prod_id</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<h2 id="检索数据">检索数据</h2>

<ul>
  <li>使用换行书写的方式更易于调试</li>
  <li>以分号结束每条语句</li>
  <li>不区分大小写，建议大写关键字</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">prod_name</span> <span class="p">,</span> <span class="n">prod_id</span><span class="p">,</span> <span class="n">prod_city</span>
<span class="k">FROM</span> <span class="n">Products</span><span class="p">;</span>
</code></pre></div></div>

<p>不显示重复值, <code class="highlighter-rouge">DISTINCT</code>关键字作用于所有列</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="n">vend_id</span>
<span class="k">FROM</span> <span class="n">Products</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="排列数据">排列数据</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">prod_name</span>
<span class="k">FROM</span> <span class="n">Products</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">prod_name</span> <span class="k">DESC</span><span class="p">,</span> <span class="n">prod_price</span>
<span class="k">LIMIT</span> <span class="mi">5</span> <span class="k">OFFSET</span> <span class="mi">5</span> <span class="p">;</span>
<span class="c1">-- 从第5行起的5行数据</span>
<span class="c1">-- 先按照名字排序，然后 *相同*(严格相同) 名字中再按价格排序</span>
<span class="c1">-- 对输出进行排序  ( ORDER BY 子句要保障是最后一条子句 )</span>
<span class="c1">-- DESC    -- 默认按照升序排列，指定DESC按照降序排列</span>
<span class="c1">-- 注意先后顺序</span>
</code></pre></div></div>

<blockquote>
  <p>如果想在多个列降序，必须对每一列指定DESC关键字
 DESC 是 DESCENDING 的缩写</p>
</blockquote>

<h2 id="过滤数据">过滤数据</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">prod_name</span><span class="p">,</span><span class="n">prod_price</span>
<span class="k">FROM</span> <span class="n">Products</span>
<span class="k">WHERE</span> <span class="n">prod_desc</span> <span class="k">IS</span> <span class="k">NULL</span><span class="p">;</span>
<span class="c1">-- WHERE prod_price = 3.49;</span>
<span class="c1">-- WHERE prod_price BETWEEN 5 AND 10;</span>
<span class="c1">-- WHERE prod_name = 'apple iphone5'</span>
<span class="c1">-- 如果将值与字符串类型的列进行比较，就需要加上引号</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th>操作符</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>=</td>
      <td>等于</td>
    </tr>
    <tr>
      <td>&lt; &gt;</td>
      <td>不等于</td>
    </tr>
    <tr>
      <td>!=</td>
      <td>不等于</td>
    </tr>
    <tr>
      <td>&lt;</td>
      <td>小于</td>
    </tr>
    <tr>
      <td>&lt;=</td>
      <td>小于等于</td>
    </tr>
    <tr>
      <td>!&lt;</td>
      <td>不小于</td>
    </tr>
    <tr>
      <td>&gt;</td>
      <td>大于</td>
    </tr>
    <tr>
      <td>&gt;=</td>
      <td>大于等于</td>
    </tr>
    <tr>
      <td>!&gt;</td>
      <td>不大于</td>
    </tr>
    <tr>
      <td>BETWEEN</td>
      <td>在指定的值之间</td>
    </tr>
    <tr>
      <td>IS NULL</td>
      <td>为NULL值</td>
    </tr>
  </tbody>
</table>

<h2 id="高级过滤数据">高级过滤数据</h2>

<p>组合<code class="highlighter-rouge">where</code>子句</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">prod_name</span><span class="p">,</span><span class="n">prod_price</span>
<span class="k">FROM</span> <span class="n">products</span>
<span class="k">WHERE</span> <span class="n">prod_name</span> <span class="o">=</span> <span class="s1">'iphone'</span>
<span class="k">AND</span> <span class="n">prod_price</span> <span class="o">&lt;</span> <span class="mi">120</span><span class="p">;</span>
</code></pre></div></div>

<p>组合时需要注意优先级，<code class="highlighter-rouge">AND</code>比<code class="highlighter-rouge">OR</code>拥有更高的优先级,可以使用括号限制优先级</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">prod_name</span><span class="p">,</span><span class="n">prod_price</span>
<span class="k">FROM</span> <span class="n">products</span>
<span class="k">WHERE</span>
<span class="p">(</span> <span class="n">prod_name</span> <span class="o">=</span> <span class="s1">'iphone'</span> <span class="k">OR</span> <span class="n">prod_desc</span> <span class="o">=</span>  <span class="s1">'DELL'</span> <span class="p">)</span>
<span class="k">AND</span> <span class="n">prod_price</span> <span class="o">&lt;</span> <span class="mi">120</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">prod_name</span><span class="p">,</span><span class="n">prod_price</span>
<span class="k">FROM</span> <span class="n">products</span>
<span class="k">WHERE</span> <span class="n">vend_name</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'dell01'</span><span class="p">,</span><span class="s1">'brs01'</span><span class="p">);</span>
</code></pre></div></div>

<p>使用<code class="highlighter-rouge">IN</code>的优点</p>

<ul>
  <li>合法选项多时，IN操作符更清楚直观</li>
  <li>与其他AND和OR操作符组合使用IN时，求值顺序容易管理</li>
  <li>IN比一组OR执行更快</li>
  <li>IN可以包含其他SELECT语句</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">prod_name</span><span class="p">,</span><span class="n">prod_price</span>
<span class="k">FROM</span> <span class="n">products</span>
<span class="k">WHERE</span> <span class="k">NOT</span> <span class="n">vend_name</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'dell01'</span><span class="p">,</span><span class="s1">'brs01'</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="用通配符进行过滤">用通配符进行过滤</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>  <span class="o">*</span>
<span class="k">FROM</span> <span class="n">products</span>
<span class="k">WHERE</span> <span class="n">prod_name</span>
<span class="k">LIKE</span> <span class="s1">'%Fish%'</span><span class="p">;</span>
<span class="c1">-- %代表Fish之后的任意字符</span>
<span class="c1">-- LIKE 'Fish%';</span>
<span class="c1">-- 包含Fish</span>
<span class="c1">-- LIKE 'b%@qq.com'</span>
<span class="c1">--  找特定格式的电子邮件地址</span>
<span class="c1">-- LIKE '_____@qq.com'</span>
<span class="c1">--  _代表一个字符</span>
</code></pre></div></div>

<ul>
  <li>不要过度使用通配符</li>
  <li>确实需要使用通配符的场景，不要把它用在搜索模式的开始处</li>
  <li>注意通配符的位置</li>
</ul>

<h2 id="计算字段">计算字段</h2>

<p>存储在数据库表中的数据不一定是应用程序所需要的格式</p>

<ul>
  <li>需要公司名和公司地址，但这两各信息在不同的表中</li>
  <li>城市 省和邮政编码存储在不同的列中，但前台程序需要一个合起来的格式</li>
  <li>列数据是大小写混合的，但前台需要大写数据</li>
  <li>订单表存储物品的价格和数量，但没有总价</li>
  <li>需要根据表数据计算总数，平均数</li>
</ul>

<blockquote>
  <p>sql语句内完成的许多转换工作和格式化工作可以直接在客户端完成，不过在服务器上会更快</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- AS关键字可以创建一个别名 有时候也叫导出列</span>
<span class="k">SELECT</span>  <span class="n">vend_name</span> <span class="o">+</span> <span class="s1">' ('</span> <span class="o">+</span> <span class="n">vend_country</span> <span class="o">+</span> <span class="s1">')'</span> <span class="k">AS</span> <span class="n">vend_title</span>
<span class="k">FROM</span> <span class="n">Vendors</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">vend_name</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">prod_id</span><span class="p">,</span><span class="n">quantity</span><span class="p">,</span><span class="n">item_price</span><span class="p">,</span> <span class="n">quantity</span> <span class="o">*</span> <span class="n">item_price</span> <span class="k">AS</span> <span class="n">expanded_price</span>
<span class="k">FROM</span> <span class="n">OrderItems</span>
<span class="k">WHERE</span> <span class="n">order_num</span> <span class="o">=</span> <span class="mi">20008</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="使用函数处理数据">使用函数处理数据</h2>

<blockquote>
  <p>sql中的函数面临兼容性问题,如果使用函数，要做详细的注释</p>
</blockquote>

<p>sql中的函数类型</p>

<ul>
  <li>处理文本字符串</li>
  <li>处理数值数据</li>
  <li>处理日期和时间</li>
  <li>系统函数</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- 常用字符处理函数  UPPER LEFT LENGTH LEN LOWER LTRIM RTRIM SOUNDEX</span>
<span class="k">SELECT</span> <span class="n">vend_name</span> <span class="p">,</span> <span class="k">UPPER</span><span class="p">(</span><span class="n">vend_name</span><span class="p">)</span> <span class="k">AS</span> <span class="n">vend_name_upcase</span>
<span class="k">FROM</span> <span class="n">Vendors</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">vend_name</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">SOUNDEX</code> 函数为一个字符串生成语音格式的字符串,例子如下</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">cust_name</span><span class="p">,</span><span class="n">cust_contact</span>
<span class="k">FROM</span> <span class="n">Customers</span>
<span class="k">WHERE</span> <span class="n">cust_contact</span> <span class="o">=</span> <span class="s1">'Michael Green'</span><span class="p">;</span>
</code></pre></div></div>

<p>数据库中存储的是发音相似但拼写错误的字符串 ‘Michealle Green’,使用<code class="highlighter-rouge">SOUNDEX</code>可以查找到</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">cust_name</span><span class="p">,</span><span class="n">cust_contact</span>
<span class="k">FROM</span> <span class="n">Customers</span>
<span class="k">WHERE</span> <span class="n">SOUNDEX</span><span class="p">(</span><span class="n">cust_contact</span><span class="p">)</span> <span class="o">=</span> <span class="n">SOUNDEX</span><span class="p">(</span><span class="s1">'Michael Green'</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">order_num</span>
<span class="k">FROM</span> <span class="n">Orders</span>
<span class="k">WHERE</span> <span class="n">DATE_SUB</span><span class="p">(</span><span class="n">CURDATE</span><span class="p">(),</span><span class="n">INTERVAL</span> <span class="mi">30</span> <span class="k">DAY</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">order_date</span><span class="p">;</span>
<span class="c1">-- 查询30天以内的订单</span>
</code></pre></div></div>

<p>Mysql常用数值处理函数</p>

<table>
  <thead>
    <tr>
      <th>函数</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>AVG()</td>
      <td>返回某列的平均值</td>
    </tr>
    <tr>
      <td>COUNT()</td>
      <td>返回某列的行数</td>
    </tr>
    <tr>
      <td>MAX()</td>
      <td>返回某列的最大值</td>
    </tr>
    <tr>
      <td>MIN()</td>
      <td>返回某列的最小值</td>
    </tr>
    <tr>
      <td>SUM()</td>
      <td>返回某列值之和</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>以上5各函数都可以搭配<code class="highlighter-rouge">DISTINCT</code>参数</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="n">prod_price</span><span class="p">)</span> <span class="k">AS</span> <span class="n">avg_price</span>
<span class="k">FROM</span> <span class="n">Products</span>

<span class="k">SELECT</span> <span class="k">AVG</span><span class="p">(</span><span class="k">DISTINCT</span> <span class="n">prod_price</span><span class="p">)</span> <span class="k">AS</span> <span class="n">avg_price</span>
<span class="k">FROM</span> <span class="n">Products</span>
<span class="k">WHERE</span> <span class="n">vend_id</span> <span class="o">=</span> <span class="s1">'DLL01'</span><span class="p">;</span>

<span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">num_counts</span>
<span class="k">FROM</span> <span class="n">Products</span><span class="p">;</span>

<span class="k">SELECT</span> <span class="k">MIN</span><span class="p">(</span><span class="n">prod_price</span><span class="p">)</span> <span class="k">AS</span> <span class="n">min_price</span>
<span class="k">FROM</span> <span class="n">Products</span><span class="p">;</span>

<span class="k">SELECT</span> <span class="k">SUM</span><span class="p">(</span><span class="n">quantity</span><span class="p">)</span> <span class="k">AS</span> <span class="n">items_ordered</span>
<span class="k">FROM</span> <span class="n">OrderItems</span>
<span class="k">WHERE</span> <span class="n">order_num</span> <span class="o">=</span> <span class="mi">20005</span><span class="p">;</span>

</code></pre></div></div>

<blockquote>
  <p>可以组合</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span>
<span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">num_items</span><span class="p">,</span>
<span class="k">MIN</span><span class="p">(</span><span class="n">prod_price</span><span class="p">)</span> <span class="k">AS</span> <span class="n">price_min</span><span class="p">,</span>
<span class="k">MAX</span><span class="p">(</span><span class="n">prod_price</span><span class="p">)</span> <span class="k">AS</span> <span class="n">price_max</span><span class="p">,</span>
<span class="k">AVG</span><span class="p">(</span><span class="n">prod_price</span><span class="p">)</span> <span class="k">AS</span> <span class="n">price_avg</span>
<span class="k">FROM</span>
<span class="n">Products</span>
</code></pre></div></div>

<h2 id="分组数据">分组数据</h2>

<blockquote>
  <p>计算每一种商品各有多少个</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">vend_id</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">num_prods</span>
<span class="k">FROM</span> <span class="n">Products</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">vend_id</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">GROUP BY</code> 子句可以包含任意数目的列，因而可以对分组进行嵌套，进行更细致的分组</li>
  <li>如果在 <code class="highlighter-rouge">GROUP BY</code> 子句中嵌套了分组，数据将在最后指定的分组上进行汇总</li>
  <li><code class="highlighter-rouge">GROUP BY</code>子句中列出每一列都必须是检索列或有效的表达式（不能是聚集函数），如果在<code class="highlighter-rouge">SELECT</code>中使用表达式，则必须在<code class="highlighter-rouge">GROUP BY</code> 子句中指定相同的表达式。不能使用别名</li>
  <li>除聚集计算语句外，<code class="highlighter-rouge">SELECT</code> 语句中的每一列都必须在 <code class="highlighter-rouge">GROUPBY</code> 子句中给出</li>
  <li><code class="highlighter-rouge">GROUP BY</code> 子句必须出现在 <code class="highlighter-rouge">WHERE</code> 子句之前，<code class="highlighter-rouge">ORDER BY</code> 子句之后</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">cust_id</span> <span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">orders</span>
<span class="k">FROM</span> <span class="n">Orders</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">cust_id</span>
<span class="k">HAVING</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">;</span>
</code></pre></div></div>
<blockquote>
  <p><code class="highlighter-rouge">WHERE</code> 在数据分组前进行过滤, HAVING 在数据分组后进行过滤。</p>
</blockquote>

<p>过去12个月内具有两个以上订单的用户</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">vend_id</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">num_prods</span>
<span class="k">FROM</span> <span class="n">Products</span>
<span class="k">WHERE</span> <span class="n">prod_price</span> <span class="o">&gt;=</span> <span class="mi">4</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">vend_id</span>
<span class="k">HAVING</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">;</span>
</code></pre></div></div>

<blockquote>
  <p>一般在使用<code class="highlighter-rouge">GROUP BY</code>子句时，应该也给出<code class="highlighter-rouge">ORDER BY</code>子句。保障数据正确排序</p>
</blockquote>

<h2 id="select-子句顺序">SELECT 子句顺序</h2>

<table>
  <thead>
    <tr>
      <th>子句</th>
      <th>说明</th>
      <th>是否必须</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>SELECT</td>
      <td>要返回的列或表达式</td>
      <td>是</td>
    </tr>
    <tr>
      <td>FROM</td>
      <td>要检索的表</td>
      <td>仅在从表选择数据时使用</td>
    </tr>
    <tr>
      <td>WHERE</td>
      <td>行级过滤</td>
      <td>否</td>
    </tr>
    <tr>
      <td>GROUP BY</td>
      <td>分组说明</td>
      <td>仅在按组计算聚集时使用</td>
    </tr>
    <tr>
      <td>HAVING</td>
      <td>组级过滤</td>
      <td>否</td>
    </tr>
    <tr>
      <td>ORDER BY</td>
      <td>输出排序顺序</td>
      <td>否</td>
    </tr>
  </tbody>
</table>

<h2 id="使用子查询">使用子查询</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">cust_id</span>
<span class="k">FROM</span> <span class="n">Orders</span>
<span class="k">WHERE</span> <span class="n">order_num</span> <span class="k">IN</span> <span class="p">(</span>
  <span class="k">SELECT</span> <span class="n">order_num</span>
  <span class="k">FROM</span> <span class="n">OrderItems</span>
  <span class="k">WHERE</span> <span class="n">prod_id</span> <span class="o">=</span> <span class="s1">'rgan01'</span>
<span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>作为子查询的SELECT语句只能查询单个列.</li>
  <li>注意子查询的性能</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">cust_name</span><span class="p">,</span><span class="n">cust_state</span><span class="p">,(</span>
  <span class="k">SELECT</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="n">Orders</span>
  <span class="k">WHERE</span> <span class="n">Orders</span><span class="p">.</span><span class="n">cust_id</span> <span class="o">=</span> <span class="n">Customers</span><span class="p">.</span><span class="n">cust_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">orders</span>
<span class="p">)</span>
<span class="k">FROM</span> <span class="n">Customes</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">cust_name</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="联结表">联结表</h2>

<blockquote>
  <p>同一供应商生产多种物品 供应商名，地址，联系方法和商品会分开存储</p>
</blockquote>

<p>理由：</p>

<ul>
  <li>对每个产品重复供应商信息浪费时间空间</li>
  <li>供应商信息发生变化，只需修改一次</li>
  <li>不要让相同的数据出现多次</li>
</ul>

<blockquote>
  <p>关系型数据库的可伸缩性远比非关系型数据库好</p>
</blockquote>

<blockquote>
  <p>把数据分开存储之后检索需要使用联结</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">vend_name</span><span class="p">,</span><span class="n">prod_name</span><span class="p">,</span><span class="n">prod_price</span>
<span class="k">FROM</span> <span class="n">Vendors</span><span class="p">,</span><span class="n">Products</span>
<span class="k">WHERE</span> <span class="n">Vendors</span><span class="p">.</span><span class="n">vend_id</span> <span class="o">=</span> <span class="n">Products</span><span class="p">.</span><span class="n">vend_id</span><span class="p">;</span>


<span class="k">SELECT</span> <span class="n">vend_name</span><span class="p">,</span><span class="n">prod_name</span><span class="p">,</span><span class="n">prod_price</span>
<span class="k">FROM</span> <span class="n">Vendors</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">Products</span>
<span class="k">ON</span> <span class="n">Vendors</span><span class="p">.</span><span class="n">vend_id</span> <span class="o">=</span> <span class="n">Products</span><span class="p">.</span><span class="n">vend_id</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="创建高级联结">创建高级联结</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">cust_name</span><span class="p">,</span><span class="n">cust_contact</span>
<span class="k">FROM</span> <span class="n">Customers</span> <span class="k">AS</span> <span class="k">C</span><span class="p">,</span><span class="n">Orders</span> <span class="k">AS</span> <span class="n">O</span><span class="p">,</span><span class="n">OrderItems</span> <span class="k">AS</span> <span class="n">OI</span>
<span class="k">WHERE</span>
<span class="k">C</span><span class="p">.</span><span class="n">cust_id</span>  <span class="o">=</span> <span class="n">O</span><span class="p">.</span><span class="n">cust_id</span>
<span class="k">AND</span> <span class="n">OI</span><span class="p">.</span><span class="n">order_num</span> <span class="o">=</span> <span class="n">O</span><span class="p">.</span><span class="n">order_num</span>
<span class="k">AND</span> <span class="n">prod_id</span> <span class="o">=</span> <span class="s1">'RGAN01'</span><span class="p">;</span>
</code></pre></div></div>

<blockquote>
  <p>以上使用为内联结或等值联结
接下来我们来看其他三种联结 自联结 自然联结 和外联结</p>
</blockquote>

<p>使用自联结替换一次子查询</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">c1</span><span class="p">.</span><span class="n">cust_id</span><span class="p">,</span><span class="n">c1</span><span class="p">.</span><span class="n">cust_name</span><span class="p">,</span><span class="n">c1</span><span class="p">.</span><span class="n">cust_contact</span>
<span class="k">FROM</span> <span class="n">Customers</span> <span class="k">AS</span> <span class="n">c1</span><span class="p">,</span> <span class="n">Customers</span> <span class="k">AS</span> <span class="n">c2</span>
<span class="k">WHERE</span> <span class="n">c1</span><span class="p">.</span><span class="n">cust_name</span> <span class="o">=</span> <span class="n">c2</span><span class="p">.</span><span class="n">cust_name</span>
<span class="k">AND</span> <span class="n">c2</span><span class="p">.</span><span class="n">cust_contact</span> <span class="o">=</span> <span class="s1">'Jim Jones'</span><span class="p">;</span>
</code></pre></div></div>

<p>标准的联结返回所有数据，相同的列甚至出现多次。自然联结排除列多次出现的问题</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="k">C</span><span class="p">.</span><span class="o">*</span> <span class="p">,</span> <span class="n">O</span><span class="p">.</span><span class="n">order_num</span>
<span class="k">FROM</span> <span class="n">Customers</span> <span class="k">AS</span> <span class="k">C</span> <span class="p">,</span> <span class="n">Orders</span> <span class="k">AS</span> <span class="n">O</span>
<span class="k">WHERE</span> <span class="k">C</span><span class="p">.</span><span class="n">cust_id</span> <span class="o">=</span> <span class="n">O</span><span class="p">.</span><span class="n">cust_di</span>
</code></pre></div></div>

<p>许多联结将一个表中的行和另一个表中的行相关联，但是有时候需要包含没有关联行的那些行，这个时候需要使用外联结</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">Customers</span><span class="p">.</span><span class="n">cust_id</span><span class="p">,</span><span class="n">Orders</span><span class="p">.</span><span class="n">order_num</span>
<span class="k">FROM</span> <span class="n">Customers</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">Orders</span>
<span class="k">ON</span> <span class="n">Customers</span><span class="p">.</span><span class="n">cust_id</span> <span class="o">=</span> <span class="n">Orders</span><span class="p">.</span><span class="n">cust_id</span>
</code></pre></div></div>

<p>带聚集函数的联结，比如检索所有的顾客及每个顾客所下的订单数</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">Customers</span><span class="p">.</span><span class="n">cust_id</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="n">Orders</span><span class="p">.</span><span class="n">order_num</span><span class="p">)</span> <span class="k">AS</span> <span class="n">num_ord</span>
<span class="k">FROM</span> <span class="n">Customers</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="n">Orders</span>
<span class="k">ON</span> <span class="n">Customers</span><span class="p">.</span><span class="n">cust_id</span> <span class="o">=</span> <span class="n">Orders</span><span class="p">.</span><span class="n">cust_id</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">Customers</span><span class="p">.</span><span class="n">cust_id</span>
</code></pre></div></div>

<h2 id="组合查询">组合查询</h2>

<blockquote>
  <p>多数SQL查询只包含从一个或多个表中返回数据的单条SELECT语句。但是，SQL允许执行多个查询，并将结果作为一个结果集返回。这些组合查询通常称为并（union）或复合查询（compound query)</p>
</blockquote>

<p>应用场景</p>

<ul>
  <li>在一个查询中从不同的表返回数据结构</li>
  <li>对一个表执行多个查询，按一个查询返回数据</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">cust_name</span><span class="p">,</span> <span class="n">cust_contact</span><span class="p">,</span><span class="n">cust_email</span>
<span class="k">FROM</span> <span class="n">Customers</span>
<span class="k">WHERE</span> <span class="n">cust_state</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'IL'</span><span class="p">,</span><span class="s1">'IN'</span><span class="p">,</span><span class="s1">'MI'</span><span class="p">)</span>
<span class="k">UNION</span>
<span class="k">SELECT</span> <span class="n">cust_name</span><span class="p">,</span> <span class="n">cust_contact</span><span class="p">,</span><span class="n">cust_email</span>
<span class="k">FROM</span> <span class="n">Customers</span>
<span class="k">WHERE</span> <span class="n">cust_name</span> <span class="o">=</span> <span class="s1">'Fun4All'</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">cust_name</span><span class="p">,</span><span class="n">cust_contact</span><span class="p">;</span>
</code></pre></div></div>
<ul>
  <li>UNION 必须由两条或两条以上的SELECT语句组成</li>
  <li>UNION 中每个查询必须包含相同的列，表达式或聚集函数</li>
  <li>列数据类型必须兼容</li>
  <li>UNION 会自动去掉重复的行</li>
</ul>

<blockquote>
  <p>对于特别复杂的使用场景，使用union能精简查询</p>
</blockquote>

<h2 id="插入数据">插入数据</h2>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Customers</span> <span class="k">VALUES</span><span class="p">(</span>
  <span class="s1">'1000000006'</span><span class="p">,</span> <span class="s1">'Toy Land'</span><span class="p">,</span> <span class="s1">'123 Any Street'</span><span class="p">,</span> <span class="s1">'New York'</span><span class="p">,</span> <span class="s1">'NY'</span><span class="p">,</span> <span class="s1">'11111'</span><span class="p">,</span> <span class="s1">'USA'</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="k">NULL</span>
<span class="p">);</span>
</code></pre></div></div>
<blockquote>
  <p>编写依赖于特定列次序的SQL语句是很不安全的</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Customers</span><span class="p">(</span> <span class="n">cust_</span> <span class="n">id</span><span class="p">,</span> <span class="n">cust_</span> <span class="n">contact</span> <span class="p">)</span> <span class="k">VALUES</span><span class="p">(</span> <span class="s1">'10'</span><span class="p">,</span> <span class="s1">'123456789'</span><span class="p">);</span>
</code></pre></div></div>

<p>可以省略列</p>

<ul>
  <li>如果该列定义为允许NULL值</li>
  <li>如果定义中给出默认值</li>
</ul>

<blockquote>
  <p>插入检索出的数据</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Customers</span><span class="p">(</span><span class="n">cust_id</span><span class="p">,</span><span class="n">cust_contact</span><span class="p">,</span><span class="n">cust_email</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">cust_id</span><span class="p">,</span><span class="n">cust_contact</span><span class="p">,</span><span class="n">cust_email</span>
<span class="k">FROM</span> <span class="n">CustNew</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="更新和删除数据">更新和删除数据</h2>

<blockquote>
  <p>使用更新和删除前，应该保证自己有足够的安全权限</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">UPDATE</span> <span class="n">Customers</span>
<span class="k">SET</span> <span class="n">cust_email</span> <span class="o">=</span> <span class="s1">'kim@qq.com'</span><span class="p">,</span> <span class="n">cust_contact</span> <span class="o">=</span> <span class="s1">'Sam rose'</span>
<span class="k">WHERE</span> <span class="n">cust_id</span> <span class="o">=</span> <span class="s1">'100000005'</span><span class="p">;</span>

<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">Customers</span>
<span class="k">WHERE</span> <span class="n">cust_id</span> <span class="o">=</span> <span class="s1">'100000006'</span>
</code></pre></div></div>
<blockquote>
  <p>DELETE 删除整行，要删除指定的列，请使用UPDATE语句</p>
</blockquote>

<h2 id="创建和操纵表">创建和操纵表</h2>

<p>创建一张表</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Products</span>
<span class="p">(</span>
  <span class="n">prod_id</span> <span class="n">char</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="n">vend_id</span> <span class="n">char</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="n">prod_name</span> <span class="n">char</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="n">prod_price</span> <span class="n">decimal</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="n">prod_desc</span> <span class="n">text</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="k">null</span>
<span class="p">);</span>
</code></pre></div></div>

<p>创建带默认值的表</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">OrderItems</span>
<span class="p">(</span>
  <span class="n">order_num</span> <span class="n">integer</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="n">order_item</span> <span class="n">integer</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="n">prod_id</span> <span class="n">char</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="n">quantity</span> <span class="n">interger</span> <span class="k">not</span> <span class="k">null</span>  <span class="k">default</span> <span class="mi">1</span><span class="p">,</span>
  <span class="c1">---------</span>
  <span class="n">ctime</span> <span class="n">time</span> <span class="k">current_date</span><span class="p">(),</span>
  <span class="c1">---------</span>
<span class="p">)</span>
</code></pre></div></div>

<p>更新表结构</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">Vendors</span>
<span class="k">ADD</span> <span class="n">vend_phone</span> <span class="n">CHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">Vendors</span>
<span class="k">DROP</span> <span class="k">COLUMN</span> <span class="n">vend_phone</span><span class="p">;</span>
</code></pre></div></div>

<p>删除表</p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">CustCopy</span>
</code></pre></div></div>

<h2 id="使用视图">使用视图</h2>

<p>我们可以把一些需要复杂的sql联结查询才能得到的数据集创建成一张虚拟的表，这种行为在sql中被称为创建视图.</p>

<p>使用视图的好处：</p>

<ul>
  <li>重用sql</li>
  <li>简化复杂的sql操作</li>
  <li>使用表的一部分而不是整个表</li>
  <li>保护数据</li>
  <li>更改数据的格式和表示</li>
</ul>

<p>视图的限制</p>

<ul>
  <li>视图名必须唯一</li>
  <li>可以创建的视图数目没有限制</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">ProductCustomers</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="n">cust_name</span><span class="p">,</span><span class="n">cust_contact</span><span class="p">,</span><span class="n">prod_id</span>
<span class="k">FROM</span> <span class="n">Customers</span><span class="p">,</span> <span class="n">Orders</span><span class="p">,</span> <span class="n">OrderItems</span>
<span class="k">WHERE</span> <span class="n">Customers</span><span class="p">.</span><span class="n">cust_id</span> <span class="o">=</span> <span class="n">Orders</span><span class="p">.</span><span class="n">cust_id</span>
<span class="k">AND</span> <span class="n">OrderItems</span><span class="p">.</span><span class="n">order_num</span> <span class="o">=</span> <span class="n">Orders</span><span class="p">.</span><span class="n">order_num</span><span class="p">;</span>


<span class="k">SELECT</span> <span class="n">cust_name</span><span class="p">,</span> <span class="n">cust_contact</span>
<span class="k">FROM</span> <span class="n">ProductCustomers</span>
<span class="k">WHERE</span> <span class="n">prod_id</span> <span class="o">=</span> <span class="s1">'RGAN01'</span><span class="p">;</span>
</code></pre></div></div>

<h2 id="使用存储过程">使用存储过程</h2>

<ul>
  <li>为了处理订单，必须核对以保证库存中有相应的物品</li>
  <li>如果物品中有库存，需要预定，不再出售给别的人，并且减少物品数据以反映正确的库存量</li>
  <li>库存中没有的物品需要订购，这需要与供应商进行某种交互</li>
  <li>关于哪些物品入库和哪些物品退订，需要通知相应的顾客</li>
</ul>

<p>存储过程就是为以后使用而保存的一条或多条SQL语句。可将其视为批处理文件</p>

<ul>
  <li>通过把处理封装在一个易用的单元中，可以简化复杂的操作</li>
  <li>由于不要求反复建立一系列处理步骤，可以保证数据的一致性，如果所有开发人员和应用程序都使用同一存储过程，则使用的代码都是相同的</li>
  <li>简化对变动的管理</li>
  <li>存储过程通常以编译过的形式存储，性能更高</li>
</ul>

<blockquote>
  <p>mysql中的存储过程</p>
</blockquote>

<h2 id="事务">事务</h2>

<p>使用事务处理（transaction processing) ,通过确保成批的sql操作要么完全执行，要么完全不执行，来维护数据库的完整性。</p>

<p>给系统添加订单的过程如下：</p>

<ol>
  <li>检查数据库中是否存在相应的顾客，如果不存在，添加他；</li>
  <li>检索顾客的ID；</li>
  <li>在Orders表中添加一行，它与顾客ID相关联</li>
  <li>检索Orders表中赋予新订单的 ID</li>
  <li>为订购的每个物品在OrderItems表中添加一行，通过检索出来的ID把它与Orders表相关联</li>
</ol>

<p>假设某种数据库故障，这个过程无法实现。</p>

<p>如果故障发生在添加顾客之后，添加Orders表之前，则不会有什么问题。某些顾客没有订单是完全合法的。重新执行此过程，所插入的顾客记录将被检索和使用。可以有效的从出故障的地方开始执行此过程。</p>

<p>但是，如果故障发生在插入Orders行之后，添加OrderItems行之前，结果就是数据库中存在不完整的订单。而我们都不知道</p>

<p>解决这种问题需要使用事务</p>

<ul>
  <li>事务(transaction) 指一组SQL语句</li>
  <li>回退(rollback)指撤销指定SQL语句的过程</li>
  <li>提交(commit) 指将未存储的sql语句结果写入数据库表</li>
  <li>保留点(savepoint)指事务处理中设置的临时占位符（placeholder),可以对它发布回退（与回退整个事务处理不同）</li>
</ul>

<blockquote>
  <p>事务处理用来管理INSERT UPDATE DELETE 语句。 不能回退SELECT语句 也不能回退 CREATE DROP</p>
</blockquote>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">START</span> <span class="n">TRANSACTION</span>

<span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">Orders</span><span class="p">;</span>
<span class="k">ROLLBACK</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">START</span> <span class="n">TRANSACTION</span>
<span class="k">DELETE</span> <span class="n">OrderItems</span> <span class="k">WHERE</span> <span class="n">order_num</span> <span class="o">=</span> <span class="mi">12345</span><span class="p">;</span>
<span class="k">DELETE</span> <span class="n">Orders</span> <span class="k">WHERE</span> <span class="n">order_num</span> <span class="o">=</span> <span class="mi">12345</span><span class="p">;</span>
<span class="k">COMMIT</span> <span class="n">TRANSACTION</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- 保留点</span>
<span class="n">SAVEPOINT</span> <span class="n">delete1</span><span class="p">;</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">BEGIN</span> <span class="n">TRANSACTION</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Customers</span><span class="p">(</span><span class="n">cust_id</span><span class="p">,</span><span class="n">cust_name</span><span class="p">)</span>
<span class="k">VALUES</span><span class="p">(</span><span class="s1">'10000'</span><span class="p">,</span><span class="s1">'Toys Emporium'</span><span class="p">);</span>
<span class="n">SAVE</span> <span class="n">TRANSACTION</span> <span class="n">StartOrder</span><span class="p">;</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Orders</span><span class="p">(</span><span class="n">order_num</span><span class="p">,</span><span class="n">order_date</span><span class="p">,</span><span class="n">cust_id</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span><span class="mi">20100</span><span class="p">,</span><span class="s1">'2011/12/1'</span><span class="p">,</span><span class="s1">'1000000010'</span><span class="p">);</span>
<span class="n">IF</span> <span class="o">@@</span><span class="n">ERROR</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">ROLLBACK</span> <span class="n">TRANSACTION</span> <span class="n">StartOrder</span><span class="p">;</span>
<span class="k">COMMIT</span> <span class="n">TRANSACTION</span>
</code></pre></div></div>

<h2 id="使用游标">使用游标</h2>

<p>有时候需要在检索出的行中前进或者后退一行或多行，这就是游标的用途。游标是一个存储在服务器上数据库查询，它不是一条select语句，而是被该语句检索出来的结果集。在存储了游标之后，应用程序可以根据需要滚动或浏览其中的数据。</p>

<h2 id="高级sql特性">高级sql特性</h2>

<h4 id="约束">约束</h4>

<p>关系数据库存储分解为多个表的数据，每个表存储相应的数据。利用键来建立从一个表到另一个表的引用（由此产生术语引用完整性）。
正确的进行关系数据库设计，需要一种方法保证只在表中插入合法数据。例如，如果Orders表存储订单信息，OrdersItems表存储订单详细内容，应该保证OrderItems中引用的任何订单ID都存在于Orders中，类似的，在Orders表中引用的任意顾客必须存在于Customs表中。</p>

<p>虽然可以在插入新行时进行检查，但是最好不要这样做，原因如下：</p>

<ul>
  <li>如果在客户端层面上实施数据完整性规则，则每个客户端都要被迫实施这些规则，一定会有一些客户端不实施这些规则</li>
  <li>在执行update和delete操作时，也必须实施这些规则。</li>
  <li>执行客户端检查非常耗时。</li>
</ul>

<blockquote>
  <p>约束  管理如何插入或处理数据库数据规则</p>
</blockquote>

<h4 id="添加一个主键">添加一个主键</h4>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Vendors</span>
<span class="p">(</span>
  <span class="n">vend_id</span> <span class="n">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="n">vend_name</span> <span class="n">CHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">)</span>
</code></pre></div></div>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">Vendors</span>
<span class="k">ADD</span> <span class="k">CONSTRAINT</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">(</span><span class="n">vend_id</span><span class="p">);</span>
</code></pre></div></div>

<h4 id="外键">外键</h4>

<p>外键是表中的一列，其值必须列在另一个表的主键中，外键是保证引用完整性的及其重要的部分。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Orders</span>
<span class="p">(</span>
  <span class="n">order_num</span> <span class="n">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
  <span class="n">order_date</span> <span class="n">DATETIME</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="p">,</span>
  <span class="n">cust_id</span> <span class="n">CHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">REFERENCES</span> <span class="n">Customers</span><span class="p">(</span><span class="n">cust_id</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<p>以上示例中 cust_id的值必须是Customers表中cust_id的值。</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">Orders</span>
<span class="k">ADD</span> <span class="k">CONSTRAINT</span> 
<span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="n">cust_id</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="n">Customers</span><span class="p">(</span><span class="n">cust_id</span><span class="p">);</span>
</code></pre></div></div>

<blockquote>
  <p>外键有助于防止意外删除</p>
</blockquote>

<h4 id="唯一约束">唯一约束</h4>

<p>唯一约束用来保证一列中的数据是唯一的。他们类似于主键，但存在以下重要区别</p>

<ul>
  <li>表可以包含多个唯一约束，但每个表只允许一个主键</li>
  <li>唯一约束列可包含NULL值</li>
  <li>唯一约束列可修改或更新</li>
  <li>唯一约束列可重复使用</li>
  <li>与主键不一样，唯一约束不能用来定义外键</li>
</ul>

<p>唯一约束可以使用 UNIQUE关键字在表定义中定义</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span>  <span class="k">user</span>
<span class="err">{</span>
  <span class="n">u_id</span> <span class="n">interger</span> <span class="k">not</span> <span class="k">null</span> <span class="k">primary</span> <span class="k">key</span><span class="p">,</span>
  <span class="n">card_num</span> <span class="n">interger</span> <span class="k">not</span> <span class="k">null</span> <span class="k">unique</span>
<span class="err">}</span>
</code></pre></div></div>

<h4 id="检查约束">检查约束</h4>

<p>检查约束用来保证一列中的数据满足一组指定的条件。检查约束的常见用途</p>

<ul>
  <li>检查最大最小值。例如，防止0个物品的订单（即使0是合法的数）</li>
  <li>指定范围。例如，保证发货日期大于等于今天的日期，但不超过今天起一年后的日期</li>
  <li>只允许特定的值。例如，在性别字段中只允许M或F</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">OrderItems</span>
<span class="p">(</span>
  <span class="n">order_num</span> <span class="n">Interger</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="n">order_item</span> <span class="n">interger</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="n">prod_id</span> <span class="n">char</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
  <span class="n">quantity</span> <span class="n">interger</span>  <span class="k">not</span> <span class="k">null</span> <span class="k">check</span><span class="p">(</span><span class="n">quantity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span>
  <span class="n">item_price</span> <span class="n">money</span> <span class="n">nto</span> <span class="k">null</span>
<span class="p">);</span>
<span class="k">ADD</span> <span class="n">CONSTAINT</span> <span class="k">CHECK</span> <span class="p">(</span><span class="n">gender</span> <span class="k">LIKE</span> <span class="s1">'[MF]'</span><span class="p">);</span>
</code></pre></div></div>

<h4 id="索引">索引</h4>

<p>索引用来排序数据以加快搜索和排序操作的速度。</p>

<p>主键不用定义索引</p>

<p>可以在一个或多个列上定义索引，使数据库保存其内容的一个排过序的列表。在定义了索引之后，数据库以使用书的索引类似的方法使用它。数据库搜索排过序的索引，找出匹配的位置，然后检索这些行。</p>

<ul>
  <li>索引改善检索操作的性能，但降级了数据插入，修改和删除的性能。在执行这些操作时，数据库必须动态的更新索引</li>
  <li>索引数据可能要占用大量的存储空间</li>
  <li>并非所有数据都合适做索引。取值不多的数据不如具有更多可能值的数据（如姓或者名），能通过索引得到那么多的好处</li>
  <li>索引用于数据过滤和数据排序。如果你经常以某种特定的顺序排序数据，则该数据可能适合做索引</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">prod_name_ind</span>
<span class="k">ON</span> <span class="n">Products</span> <span class="p">(</span><span class="n">prod_name</span><span class="p">);</span>
</code></pre></div></div>
<p>索引必须唯一命名。</p>

<h4 id="触发器">触发器</h4>

<p>触发器可以与特定表上的Insert update delete操作相关联</p>

  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/newlifebegins"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">newlifebegins</span></a>

            <span>fullstack web developer
</span>
          </li>
          
        </ul>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
